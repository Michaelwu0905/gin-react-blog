name: Build and Push Docker Images

on:
  push:
    branches: ["main"]
  workflow_dispatch: # 允许你在 GitHub 网页上手动触发

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. 构建并推送 后端 镜像
      - name: Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend # Dockerfile 所在的目录
          file: ./backend/Dockerfile
          push: true
          # 镜像标签：用户名/仓库名:latest
          tags: ${{ secrets.DOCKER_USERNAME }}/my-blog-backend:latest

      # 4. 构建并推送 前端 镜像
      - name: Build and Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend # Dockerfile 所在的目录
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/my-blog-frontend:latest

  deploy:
    needs: build-and-push # 必须等构建成功才部署
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 下面是在服务器上执行的脚本
          script: |
            # 1. 停止并删除旧容器 (如果存在)
            docker stop blog-backend blog-frontend || true
            docker rm blog-backend blog-frontend || true

            # 2. 拉取刚才构建的最新镜像
            docker pull ${{ secrets.DOCKER_USERNAME }}/my-blog-backend:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/my-blog-frontend:latest

            # 3. 创建网络 (如果不存在)
            docker network create blog-network || true

            # 4. 启动数据库 (如果数据库是独立部署的，这里可以省略，或者确保它已经在运行)
            # 建议数据库不要每次 CI/CD 都重启，最好手动在服务器上 docker run 一次mysql即可

            # 5. 启动后端
            docker run -d \
              --name blog-backend \
              --network blog-network \
              -e DB_HOST=blog-db \
              -e DB_USER=root \
              -e DB_PASSWORD=Leahc1misM1chael \
              -e DB_NAME=blog_db \
              ${{ secrets.DOCKER_USERNAME }}/my-blog-backend:latest

            # 6. 启动前端 (映射 80 端口)
            docker run -d \
              --name blog-frontend \
              --network blog-network \
              -p 80:80 \
              ${{ secrets.DOCKER_USERNAME }}/my-blog-frontend:latest
